#!/usr/bin/ruby -Ku
require 'rubygems'
require 'kconv'
require  'pp'
#
mode = "1"          # 0 = おきかえ / 1 = 追加
SYS_EX_LIMIT = 127  # キャラコードが127個まで
#
phonetic = {
  "あ" => "a",
  "い" => "i",
  "う" => "M",
  "え" => "e",
  "お" => "o",
  "か" => "ka",
  "き" => "k'i",
  "く" => "kM",
  "け" => "ke",
  "こ" => "ko",
  "さ" => "sa",
  "し" => "Si",
  "す" => "sM",
  "せ" => "se",
  "そ" => "so",
  "た" => "ta",
  "ち" => "tSi",
  "つ" => "tsM",
  "て" => "te",
  "と" => "to",
  "な" => "na",
  "に" => "Ji",
  "ぬ" => "nM",
  "ね" => "ne",
  "の" => "no",
  "は" => "ha",
  "ひ" => "Ci",
  "ふ" => "p\\M",
  "へ" => "he",
  "ほ" => "ho",
  "ま" => "ma",
  "み" => "m'i",
  "む" => "mM",
  "め" => "me",
  "も" => "mo",
  "ら" => "4a",
  "り" => "4'i",
  "る" => "4M",
  "れ" => "4e",
  "ろ" => "4o",
  "が" => "ga",
  "ぎ" => "g'i",
  "ぐ" => "gM",
  "げ" => "ge",
  "ご" => "go",
  "ざ" => "dza",
  "じ" => "dZi",
  "ず" => "dzM",
  "ぜ" => "dze",
  "ぞ" => "dzo",
  "だ" => "da",
  "ぢ" => "dZi",
  "づ" => "dzM",
  "で" => "de",
  "ど" => "do",
  "ば" => "ba",
  "び" => "b'i",
  "ぶ" => "bM",
  "べ" => "be",
  "ぼ" => "bo",
  "ぱ" => "pa",
  "ぴ" => "p'i",
  "ぷ" => "pM",
  "ぺ" => "pe",
  "ぽ" => "po",
  "や" => "ja",
  "ゆ" => "jM",
  "よ" => "jo",
  "わ" => "wa",
  "ゐ" => "wi",
  "ゑ" => "we",
  "を" => "o",
  "ん" => "n",
  "ふぁ" => "p\\a",
  "つぁ" => "tsa",
  "うぃ" => "wi",
  "すぃ" => "si",
  "ずぃ" => "dzi",
  "つぃ" => "tsi",
  "てぃ" => "t'i",
  "でぃ" => "d'i",
  "ふぃ" => "p\\'i",
  "とぅ" => "tM",
  "どぅ" => "dM",
  "いぇ" => "je",
  "うぇ" => "we",
  "きぇ" => "k'e",
  "しぇ" => "Se",
  "ちぇ" => "tSe",
  "つぇ" => "tse",
  "てぇ" => "t'e",
  "にぇ" => "Je",
  "ひぇ" => "Ce",
  "みぇ" => "m'e",
  "りぇ" => "4'e",
  "ぎぇ" => "g'e",
  "じぇ" => "dZe",
  "でぇ" => "d'e",
  "びぇ" => "b'e",
  "ぴぇ" => "p'e",
  "ふぇ" => "p\\e",
  "うぉ" => "wo",
  "つぉ" => "tso",
  "ふぉ" => "p\\o",
  "きゃ" => "k'a",
  "しゃ" => "Sa",
  "ちゃ" => "tSa",
  "てゃ" => "t'a",
  "にゃ" => "Ja",
  "ひゃ" => "Ca",
  "みゃ" => "m'a",
  "りゃ" => "4'a",
  "ぎゃ" => "N'a",
  "じゃ" => "dZa",
  "でゃ" => "d'a",
  "びゃ" => "b'a",
  "ぴゃ" => "p'a",
  "ふゃ" => "p\\'a",
  "きゅ" => "k'M",
  "しゅ" => "SM",
  "ちゅ" => "tSM",
  "てゅ" => "t'M",
  "にゅ" => "JM",
  "ひゅ" => "CM",
  "みゅ" => "m'M",
  "りゅ" => "4'M",
  "ぎゅ" => "g'M",
  "じゅ" => "dZM",
  "でゅ" => "d'M",
  "びゅ" => "b'M",
  "ぴゅ" => "p'M",
  "ふゅ" => "p\\'M",
  "きょ" => "k'o",
  "しょ" => "So",
  "ちょ" => "tSo",
  "てょ" => "t'o",
  "にょ" => "Jo",
  "ひょ" => "Co",
  "みょ" => "m'o",
  "りょ" => "4'o",
  "ぎょ" => "N'o",
  "じょ" => "dZo",
  "でょ" => "d'o",
  "びょ" => "b'o",
  "ぴょ" => "p'o",
  " "    => " ",
  "　"   => " ",
}
#
line_file = "text.txt"
line_file = ARGV[0] if ARGV[0]
#
File.open(line_file,"r") do |file|
  file.each do |line|
    hatsuon = ""

    next if line =~ /^#/      # 先頭が#ならコメント

    line = line.toutf8
#    line = line.tr('ァ-ン','ぁ-ん')
    line.chomp!

    buf = line.split(//)
    for i in (0...buf.size)
      next if buf[i] =~ /[ぁぃぅぇぉゃゅょ]/ 

      oto = buf[i]
      if i < buf.size && buf[i + 1] =~ /[ぁぃぅぇぉゃゅょ]/ 
        oto += buf[i + 1]
      end

# warn oto.tosjis

      hatsuon += phonetic[oto] if phonetic.key?(oto)
    end

    hatsuon.rstrip!
    print "# 発音記号 #{hatsuon}\n".tosjis

    # SYS-EXに変換
    print "F0 43 79 09 00 50 1#{mode} \n".tosjis

    buf = hatsuon.split(//)
    sys_ex_len = 0

    for i in (0...buf.size)
      print "%02.2X " % buf[i].unpack("C")      # 1.9.x以降ならordのほうがいいみたい
      sys_ex_len += 1

      # 禁則処理
      if sys_ex_len > SYS_EX_LIMIT - 3 && buf[i] == ' '
        sys_ex_len = 0
        print "\n00 F7 \n".tosjis                      # 1ブロック終わり
        print "F0 43 79 09 00 50 1#{mode} \n".tosjis   # 次のブロック開始
      end
    end

    print "\n00 F7 \n"
  end
  print "\n"
end
#
# TODO:
# 撥音「ん」「ン」のあつかい
# １．語末ならば[N\]になります。                         →文章の最後の「すいません」とか
# ２．後ろが母音、半母音、摩擦音がなら[N\]になります。   →あいうえおぁぃぅぇぉ 日本語で摩擦音はどの音だろう？
# ３．後ろが両唇音(p,,b,,m,)ならば[m]になります。        →しんぶんしだとsimbunsiか
# ４．後ろが両唇音(p’,b’,m’)ならば[m']になります。    →  "ぴ" => "p'i",とか
# ５．後ろが軟口蓋音(k,g,N)ならば[N]になります。         →きんかんにっしょっくだとkiNka
# ６．後ろが軟口蓋音(k',g',N')ならば[N']になります。     →きんぎょだとkiN'N'o  "ぎょ" => "N'o",
# ７．後ろが歯茎硬口蓋音(J)ならば[J]になります。         →  "に" => "Ji",にょとか。
# ８．それ以外ならば[n]になります。                      →たいていはn
#
